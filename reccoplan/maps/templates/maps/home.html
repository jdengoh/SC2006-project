{% extends 'main.html' %}
{% load static %}

{% block title %} Homepage {% endblock title %}


{% block content %}
<title>Place Autocomplete element</title>

<style>
    #searchInput {
        width: 300px;
        padding: 10px;
        font-size: 16px;
    }
</style>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>

    
    <script>

        let map;
        let autocomplete;
        function initMap(){
           /*var input = document.getElementById('pac-input');
            var autocomplete = new google.maps.places.Autocomplete(input);
            map = new google.maps.Map(document.getElementById('map'),
            {
                center:{lat:23.346, lng: 113.684},
                zoom:8,
            });*/
            var input = document.getElementById('pac-input');
            var autocomplete = new google.maps.places.Autocomplete(input);
            currLoct = { lat: 23.23, lng: 113.13};
            map = new google.maps.Map(document.getElementById("map"), {
                center: currLoct,
                zoom: 15,
                mapId: "8d193001f940fde3",
            });


            const locationButton = document.getElementById('button');
            locationButton.textContent = 'Search for Nearby Activities';
            locationButton.classList.add('map-button');
            map.controls[google.maps.ControlPosition.TOP_CENTER].push(locationButton);
            locationButton.addEventListener('click',()=> {
                if(navigator.geolcoation){
                    navigator.geolocation.getCurrentPosition(
                        (position => {
                            const pos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                            };
                            map.setCenter(pos);
                            var marker = new google.maps.Marker({
                                positions: pos,
                                map:map,
                            });
                            map.setZoom(17);
                        })
                    )
                }
            });
            
            autocomplete.addListener('place_changed',()=>{
                const auto_marker = new google.maps.Marker({
                map,
                anchorPoint: new google.maps.Point(0,0-29),
                });

                auto_marker.setVisible(false);
                const place = autocomplete.getPlace();
                const position = place.geometry.location;
                if(!place.geometry || !place.geometry.location){
                    window.alert("No information found for ", + place.name + "." );
                } else {
                if(place.geometry.viewport){
                    map.fitBounds(place.geometry.viewport);
                } else {
                    map.setCenter(position);
                    map.setZoom(17);
                }
                const image={}; //trys to reset the window that displays the nearby places. 
                }
                auto_marker.setPosition(position);
                auto_marker.setVisible(true);
                locationButton.addEventListener('click',()=> {
                    service.nearbySearch(
                { location: position, radius: 500, type: "store" },
                (results, status, pagination) => {
                    if (status !== "OK" || !results) return;

                    addPlaces(results, map);
                    moreButton.disabled = !pagination || !pagination.hasNextPage;
                    if (pagination && pagination.hasNextPage) {
                        getNextPage = () => {
                        // Note: nextPage will call the same handler function as the initial call
                        pagination.nextPage();
                        };
                    }
                },
            );
            });
            }); 

            const service = new google.maps.places.PlacesService(map);
            let getNextPage;
            const moreButton = document.getElementById("more");

            moreButton.onclick = function () {
                moreButton.disabled = true;
                if (getNextPage) {
                    getNextPage();
                }
            };

            // Perform a nearby search.
        
        }

        function addPlaces(places, map) {
            const placesList = document.getElementById("places");
            placesList.innerHTML = '';

            for (const place of places) {
                if (place.geometry && place.geometry.location) {
                    const image = {
                        url: place.icon,
                        size: new google.maps.Size(71, 71),
                        origin: new google.maps.Point(0, 0),
                        anchor: new google.maps.Point(17, 34),
                        scaledSize: new google.maps.Size(25, 25),
                    };

                    const Placelist=new google.maps.Marker({
                        map,
                        icon: image,
                        title: place.name,
                        position: place.geometry.location,
                    });

                    const li = document.createElement("li");

                    li.textContent = place.name;
                    placesList.appendChild(li);
                    li.addEventListener("click", () => {
                    map.setCenter(place.geometry.location);
                    });
                }
            }
        }

        window.initMap = initMap;

           

        // function initAutocomplete() {
        //     var input = document.getElementById('pac-input');
        //     var autocomplete = new google.maps.places.Autocomplete(input);
            
        // }


        function AutoComplete(map){
            autocomplete = new google.maps.places.Autocomplete(document.getElementById('pac-input'));
            autocomplete.bindTo('bounds',map);


            
            }
    </script>

    
  </head>
  <body>
    <p style="font-family: roboto, sans-serif">Search for a place here:</p>
    <div id = 'search-input'>
        <input id='pac-input' type='text' placeholder='Enter a location'>
        <button id = 'button' type = 'button'> Search</button>
    </div>
        <div id="container">
            <div id="map" style ="height:500px; width:100%;"></div>
            <div id="sidebar">
                <h2>Results</h2>
                <ul id="places"></ul>
                <button id="more">Load more results</button>
            </div>
        </div>
        <script 
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDL77OS5N8c5X2khsmnCs-xvOk5z5Ig9oU&libraries=places&callback=initMap&libraries=places&v=weekly"
            defer >
        </script>
    </body>




<h1>retrieving data from database</h1>


<table>
    <thread>
        <tr>
            <th>Id</th>
            <th>Name</th>
            <th>Address</th>
            <th>Postal Code</th>
            <th>Lat</th>
            <th>Lon</th>    
        </tr>
    </thread>

    {% for a in location %}
    <tr>
        <th>{{a.id}}</th>
        <th>{{a.name}}</th>
        <th>{{a.address}}</th>
        <th>{{a.postal_code}}</th>
    </tr>

    
    {% endfor %}


</table>
<!-- <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDL77OS5N8c5X2khsmnCs-xvOk5z5Ig9oU&callback=initMap"> </script> -->
{% endblock content %}
